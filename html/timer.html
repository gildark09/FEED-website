<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Timer</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>

<header>
    <div class="logo-container">
        <img src="../image/Moon Lunala.jpg" class="logo" alt="Logo">
    </div>
    <nav>
        <ul>
            <li><a href="/html/feed.html">← Back</a></li>
        </ul>
    </nav>
</header>

    <video class="cat-video" autoplay muted loop playsinline>
      <source src="/image/cat3.mp4" type="video/mp4">
    </video>

<div class="page-center">
    <h1 class="page-title">Set Feed Time</h1>

    <div class="page-card">
        <p class="page-text">Choose a time to automatically feed.</p>

        <input type="time" class="page-input" id="feedTime">

        <p class="page-text" style="margin-top:15px;">Select Day(s):</p>

        <div class="day-select" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
            <label><input type="checkbox" value="Sun"> Sun</label>
            <label><input type="checkbox" value="Mon"> Mon</label>
            <label><input type="checkbox" value="Tue"> Tue</label>
            <label><input type="checkbox" value="Wed"> Wed</label>
            <label><input type="checkbox" value="Thu"> Thu</label>
            <label><input type="checkbox" value="Fri"> Fri</label>
            <label><input type="checkbox" value="Sat"> Sat</label>
        </div>

        <button class="page-button" onclick="saveTimer()">Save Time</button>

        <p id="timer-status" class="status-text"></p>

        
        <h2 class="page-subtitle">Scheduled Times</h2>
        <div id="scheduleList" class="schedule-list"></div>
    </div>
</div>

<script>


window.onload = loadScheduleList;



function saveTimer() {
    const time = document.getElementById("feedTime").value;
    if (!time) {
        document.getElementById("timer-status").innerHTML = "Please select a time.";
        return;
    }

    const selectedDays = [...document.querySelectorAll("input[type=checkbox]:checked")].map(c => c.value);
    if (selectedDays.length === 0) {
        document.getElementById("timer-status").innerHTML = "Select at least 1 day.";
        return;
    }

    const schedule = JSON.parse(localStorage.getItem("feedSchedule")) || [];

    schedule.push({
        time: time,
        days: selectedDays,
        lastFed: ""
    });

    localStorage.setItem("feedSchedule", JSON.stringify(schedule));

    document.getElementById("timer-status").innerHTML =
        "✔ Scheduled for " + selectedDays.join(", ") + " at " + time;

    loadScheduleList();
}


// Load and display schedule list
function loadScheduleList() {
    const box = document.getElementById("scheduleList");
    const schedule = JSON.parse(localStorage.getItem("feedSchedule")) || [];

    box.innerHTML = "";

    schedule.forEach((entry, index) => {
        const div = document.createElement("div");
        div.className = "schedule-item";

        div.innerHTML = `
            <span>${entry.days.join(", ")} — <b>${entry.time}</b></span>
            <button onclick="deleteSchedule(${index})">Delete</button>
        `;

        box.appendChild(div);
    });
}


// Delete schedule entry
function deleteSchedule(index) {
    let schedule = JSON.parse(localStorage.getItem("feedSchedule")) || [];
    schedule.splice(index, 1);
    localStorage.setItem("feedSchedule", JSON.stringify(schedule));
    loadScheduleList();
}


// Save feeding history
function saveHistory(type) {
    const now = new Date();
    const entry = {
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString(),
        type: type
    };

    let history = JSON.parse(localStorage.getItem("feedHistory")) || [];
    history.unshift(entry);
    localStorage.setItem("feedHistory", JSON.stringify(history));
}


// Auto feed loop (runs every second)
setInterval(() => {
    let schedule = JSON.parse(localStorage.getItem("feedSchedule")) || [];
    if (schedule.length === 0) return;

    const now = new Date();
    const currentTime = now.toTimeString().slice(0, 5);
    const dayName = now.toLocaleDateString("en-US", { weekday: "short" });

    schedule.forEach(entry => {
        if (entry.time === currentTime && entry.days.includes(dayName)) {

            if (entry.lastFed === currentTime) return;

            saveHistory("Scheduled");

            entry.lastFed = currentTime;

            console.log("Fed at", currentTime, "on", dayName);
        }
    });

    localStorage.setItem("feedSchedule", JSON.stringify(schedule));

}, 1000);

</script>
<script src="../autofeed.js"></script>
</body>
</html>
